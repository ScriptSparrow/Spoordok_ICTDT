
<html>
<head>

    <title>Test LLM</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>

    <style>
        body{
            height: 100vh;
            background-color: darkslategray;
            color: white;
        }

        .bg-bot {
            background-color: transparent;
        }

        .input-area {
            position: absolute;
            bottom: 2rem;
            border-radius: 8px;
            padding: 1em;
            color: white;
            background-color: #001d0c;
            resize: none;
            width: 100%;
        }
        
        .thinking {
            background-color: transparent;
            margin: 1rem;
            border-radius: 8px;
            min-height: 2em;
            max-height: 12em;
            overflow-y: auto;
        }

        .message-bubble {
            background-color: rgb(0, 80, 41);
        }

            .message-bubble.message-complete {
               background-color: rgb(0, 92, 46);
            }

            .thinking {
                background-color: rgb(0, 80, 41);
            }

        .bg-user {
            background-color: #0d6efd;
        }

        #chat-container {
            height: 80vh;
            overflow-y: auto;
            margin-bottom: 1rem;
        }

    </style>

    <script>

        {
            
        }
        const thinkingWrapper = document.createElement("div");
        thinkingWrapper.innerHTML = ` <div class="p-3 thinking">
                Sending request...
            </div>`;
        const thinkingTemplateElement = thinkingWrapper.firstElementChild;

        const botWrapper = document.createElement("div");
        botWrapper.innerHTML = `<div class="p-3 bg-bot text-white bot-message">
                </div>`;
        const botTemplateElement = botWrapper.firstElementChild;

        const wrapper = document.createElement("div");
        wrapper.innerHTML = `<div class="row mb-2">
            <div class="col-10">
                <div class="message-bubble rounded">
                    
                </div>
            </div>
            <div class="col-2"></div>
        </div>`;
        const botResponseElement = wrapper.firstElementChild;



        function appendBotResponse(initialText = "loading...") {
            const node = botResponseElement.cloneNode(true);
            return document.getElementById("chat-container").appendChild(node);
        }

        function toUserRow(prompt){
            return `<div class="row mb-2">
                        <div class="col-2"></div>
                        <div class="col-10">
                            <div class="p-3 rounded bg-user text-white">
                                ${prompt}
                            </div>
                        </div>
                    </div>`;
        }

        function appendUserPrompt(prompt) {
            const userRow = toUserRow(prompt);
            document.getElementById("chat-container").innerHTML += userRow;
        }

        const id = crypto.randomUUID();

        
        async function streamBotResponse(botMessageElement, prompt) {

            const botChatCol = botMessageElement.querySelector(".message-bubble");
            const selectedModel = document.getElementById("modelSelect").value;
            const response = await fetch(`/api/ai/chat/${id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'model': selectedModel
                },
                body: JSON.stringify({ 
                    message: prompt,
                })
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");

            var thinkingElement = null;
            var contentElement = null;
            var tool_callElement = null;

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                
                // Parse SSE format: "data: ...\n\n"
                const lines = chunk.split('\n');
                for (const line of lines) {
                    console.log('Received line:', line);

                    if (line.startsWith('data:')) {
                        const text = line.slice(5);

                        if(text.startsWith("thinking:")){

                            const contentText = text.slice(9);
                            if (contentText.trim().length === 0) {
                                continue;
                            }

                            contentElement = null;
                            tool_callElement = null;
                            if (thinkingElement === null) {
                                thinkingElement = botChatCol.appendChild(thinkingTemplateElement.cloneNode(true));
                                thinkingElement.textContent = "";
                            }
                            
                            thinkingElement.textContent += contentText;
                        } else if (text.startsWith("tool_call:")) {
                            const toolCallData = text.slice(10);
                            jsonData = JSON.parse(toolCallData);

                            thinkingElement = null;
                            contentElement = null;
                            

                        } else if (text.startsWith("content:")){
                            
                            const contentText = text.slice(8);
                            if (contentText.trim().length === 0) {
                                continue;
                            }

                            thinkingElement = null;
                            tool_callElement = null;

                            if (contentElement === null) {
                                contentElement = botChatCol.appendChild(botTemplateElement.cloneNode(true));
                            }
                            
                            contentElement.textContent += contentText;

                        } else if (text.startsWith("complete_chunk"))
                        {
                            botChatCol.classList.add("message-complete");
                        }
                    }
                }
            }

            console.log("Bot response streaming completed.");

        }

        async function loadModels() {
            try {
                const response = await fetch('/api/ai/models');
                const data = await response.json();
                
                const modelSelect = document.getElementById("modelSelect");
                modelSelect.innerHTML = ""; // Clear existing options
                
                data.availableModels.forEach(model => {
                    const option = document.createElement("option");
                    option.value = model;
                    option.textContent = model;
                    if (model === data.defaultModel) {
                        option.selected = true;
                    }
                    modelSelect.appendChild(option);
                });
            } catch (error) {
                console.error("Failed to load models:", error);
            }
        }

        document.addEventListener("DOMContentLoaded", function() {
            loadModels(); // Load models on page load

            const promptInput = document.getElementById("promptInput");

            const autosize = (el) => {
                const maxPx = parseFloat(getComputedStyle(el).maxHeight);
                el.style.height = 'auto';
                const newHeight = el.scrollHeight;
                if (!isNaN(maxPx) && newHeight > maxPx) {
                    el.style.height = maxPx + 'px';
                    el.style.overflowY = 'auto';
                } else {
                    el.style.height = newHeight + 'px';
                    el.style.overflowY = 'hidden';
                }
            };

            autosize(promptInput);
            promptInput.addEventListener('input', () => autosize(promptInput));

            promptInput.addEventListener("keydown", function(event) {
                if (event.key === "Enter" && !event.shiftKey) {
                    const prompt = promptInput.value;
                    console.log("User Prompt:", prompt);
                    // Here you can add code to send the prompt to your backend or LLM service
                    promptInput.value = ""; // Clear input after submission
                    appendUserPrompt(prompt);

                    const botMessageElement = appendBotResponse();
                    streamBotResponse(botMessageElement, prompt);

                    console.log("Bot response streaming started.");
                }
            });
        });

    </script>

</head>
<body>  

<h1>Test LLM</h1>

<div class="container">
    <div class="row">
        <div class="col-12">
            <div id="chat-container" class="container">

            </div>
        </div>
    </div>


    <div class="row">
        <div class="col-12">
             <textarea id="promptInput" class="input-area" placeholder="Enter your prompt here..."></textarea>
        </div>
       
    </div>
     <div class="row mb-3">
        <div class="col-3">
            <label for="modelSelect" class="form-label">Select Model:</label>
        </div>
        <div class="col-6">
            <select id="modelSelect" class="form-select">
                <option value="">Loading models...</option>
            </select>
        </div>
    </div>
</div>

</body>
</html>